# 正式部署方案指南

## 📊 部署架构概览

### 正式部署架构
```
┌─────────────┐
│  用户客户端 │ (Windows/Mac/Linux)
│  (Qt GUI)   │
└──────┬──────┘
       │ 互联网/公网
       │ TCP Socket (端口8888)
       ▼
┌─────────────────────────────────┐
│        云服务器/服务器          │
│  ┌──────────┐   ┌──────────┐  │
│  │ Qt服务端 │   │ MySQL    │  │
│  │ (后台运行)│   │ 数据库   │  │
│  └──────────┘   └──────────┘  │
└─────────────────────────────────┘
```

---

## 🖥️ 第一部分：服务器选择方案

### 方案一：云服务器（推荐）

#### 1.1 国内云服务商

**阿里云（推荐新手）**
- **入门配置**：1核2G，1M带宽
- **价格**：约 ¥100-200/月（按年付费更便宜）
- **优势**：
  - 文档完善，中文支持好
  - 控制台操作简单
  - 学生优惠（¥9.5/月）
- **适用场景**：中小型应用，用户量<1000

**腾讯云**
- **入门配置**：1核2G，1M带宽
- **价格**：约 ¥100-200/月
- **优势**：
  - 与微信生态集成好
  - 学生优惠（¥10/月）
- **适用场景**：与腾讯产品集成

**华为云**
- **入门配置**：1核2G，1M带宽
- **价格**：约 ¥100-200/月
- **优势**：企业级服务，稳定性好

#### 1.2 国外云服务商

**AWS（Amazon Web Services）**
- **入门配置**：t2.micro（免费套餐）
- **价格**：免费套餐12个月，之后约 $10-15/月
- **优势**：全球覆盖，功能强大
- **缺点**：配置复杂，需要信用卡

**DigitalOcean**
- **入门配置**：1核1G
- **价格**：$6/月（约¥40）
- **优势**：价格便宜，简单易用
- **适用场景**：个人项目、小型应用

**Vultr**
- **入门配置**：1核1G
- **价格**：$6/月
- **优势**：全球节点多，按小时计费

### 方案二：VPS（虚拟专用服务器）

**优点**：
- 价格相对便宜
- 完全控制权
- 适合学习和小型项目

**缺点**：
- 需要自己维护
- 稳定性可能不如大厂
- 技术支持有限

**推荐商家**：
- 搬瓦工（BandwagonHost）
- Vultr
- Linode

### 方案三：自建服务器（不推荐新手）

**适用场景**：
- 公司内部使用
- 有固定IP和机房
- 有专业运维人员

**缺点**：
- 需要固定IP（家庭宽带通常没有）
- 需要24小时开机
- 电费和网络成本
- 需要处理网络安全

---

## 💰 第二部分：成本分析

### 小型应用（用户<100）
- **服务器**：1核2G，1M带宽
- **数据库**：服务器上自建MySQL（免费）
- **月成本**：¥100-200
- **年成本**：¥1000-2000（按年付费有折扣）

### 中型应用（用户100-1000）
- **服务器**：2核4G，3M带宽
- **数据库**：云数据库RDS（可选）
- **月成本**：¥300-500
- **年成本**：¥3000-5000

### 大型应用（用户>1000）
- **服务器**：4核8G，5M带宽（或更高）
- **数据库**：独立数据库服务器
- **负载均衡**：多台服务器
- **月成本**：¥1000+
- **年成本**：¥10000+

### 学生/个人项目优惠

**阿里云学生机**：
- 1核2G，1M带宽
- 价格：¥9.5/月（需学生认证）
- 适合：学习、个人项目

**腾讯云学生机**：
- 1核2G，1M带宽
- 价格：¥10/月

---

## 🚀 第三部分：部署步骤（以阿里云为例）

### 步骤1：购买云服务器

1. **注册阿里云账号**
   - 访问：https://www.aliyun.com
   - 完成实名认证（需要身份证）

2. **购买ECS实例**
   - 进入"云服务器ECS"
   - 选择"立即购买"
   - **配置选择**：
     - 地域：选择离用户近的（如华东1-杭州）
     - 实例：共享型 ecs.t6-c1m2.large（1核2G）
     - 镜像：Ubuntu 22.04 LTS（推荐）或 CentOS 7
     - 系统盘：40GB SSD
     - 网络：专有网络VPC
     - 公网IP：分配公网IP
     - 带宽：1Mbps（可后续升级）
   - 设置root密码（记住这个密码！）
   - 购买（建议按年付费，有折扣）

### 步骤2：配置安全组（重要！）

1. **进入ECS控制台**
2. **找到你的实例 → 安全组 → 配置规则**
3. **添加规则**：
   - 端口：8888（你的服务端端口）
   - 协议：TCP
   - 授权对象：0.0.0.0/0（允许所有IP，生产环境建议限制）
   - 描述：Qt服务端端口

4. **同时开放**：
   - 22端口（SSH，用于远程连接）
   - 3306端口（MySQL，如果从外部访问）

### 步骤3：连接服务器

**Windows系统使用PuTTY或Xshell**：

```bash
# SSH连接命令
ssh root@你的服务器公网IP

# 输入root密码（输入时不显示，直接输入后回车）
```

**或者使用阿里云控制台的"远程连接"功能**

### 步骤4：安装必要软件

#### 4.1 更新系统（Ubuntu）
```bash
apt update
apt upgrade -y
```

#### 4.2 安装MySQL数据库
```bash
# 安装MySQL
apt install mysql-server -y

# 启动MySQL服务
systemctl start mysql
systemctl enable mysql

# 设置MySQL root密码
mysql_secure_installation

# 登录MySQL
mysql -u root -p

# 创建数据库和用户
CREATE DATABASE flight CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'flightuser'@'localhost' IDENTIFIED BY '你的密码';
GRANT ALL PRIVILEGES ON flight.* TO 'flightuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### 4.3 导入数据库
```bash
# 将你的 init_database.sql 上传到服务器
# 可以使用 scp 命令或 FTP 工具

# 导入数据库
mysql -u flightuser -p flight < init_database.sql
```

#### 4.4 安装Qt运行环境（如果服务端是Qt程序）

**方法一：静态编译（推荐）**
- 在本地编译时使用静态链接
- 这样服务器上不需要安装Qt库
- 只需要一个可执行文件

**方法二：安装Qt库**
```bash
# 下载Qt库（需要根据你的Qt版本）
# 或者使用包管理器安装
```

**方法三：使用Docker（高级）**
- 将服务端打包成Docker镜像
- 服务器上运行Docker容器

### 步骤5：上传服务端程序

**使用SCP上传**（Windows可以用WinSCP）：
```bash
# 在本地命令行执行
scp FlightServer root@服务器IP:/root/

# 或者使用FTP工具（FileZilla等）
```

**设置执行权限**：
```bash
ssh root@服务器IP
chmod +x /root/FlightServer
```

### 步骤6：配置服务端

**修改服务端配置文件**（如果有）：
- 数据库连接信息改为服务器上的配置
- 监听地址改为 `0.0.0.0`（允许外部连接）

**或者直接在代码中修改**：
```cpp
// server.cpp
if (!server.listen(QHostAddress::Any, 8888)) {
    // 监听所有网络接口
}
```

### 步骤7：运行服务端

#### 方法一：直接运行（测试用）
```bash
cd /root
./FlightServer
```

#### 方法二：后台运行（推荐）
```bash
# 使用 nohup
nohup ./FlightServer > server.log 2>&1 &

# 查看日志
tail -f server.log
```

#### 方法三：使用systemd服务（生产环境推荐）

**创建服务文件**：
```bash
nano /etc/systemd/system/flight-server.service
```

**内容**：
```ini
[Unit]
Description=Flight Booking Server
After=network.target mysql.service

[Service]
Type=simple
User=root
WorkingDirectory=/root
ExecStart=/root/FlightServer
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**启用服务**：
```bash
systemctl daemon-reload
systemctl enable flight-server
systemctl start flight-server

# 查看状态
systemctl status flight-server

# 查看日志
journalctl -u flight-server -f
```

### 步骤8：修改客户端连接地址

**在客户端代码中修改服务器地址**：
```cpp
// networkmanager.cpp 或 networkclient.cpp
bool NetworkManager::connectToServer()
{
    // 改为你的服务器公网IP
    return m_client->connectToServer("你的服务器公网IP", 8888);
}
```

**或者使用配置文件**：
```cpp
// 读取配置文件中的服务器地址
QString serverIP = settings.value("server/ip", "127.0.0.1").toString();
```

---

## 🔒 第四部分：安全配置

### 1. 防火墙配置

```bash
# Ubuntu使用ufw
ufw allow 22/tcp    # SSH
ufw allow 8888/tcp  # 你的服务端端口
ufw enable
```

### 2. 数据库安全

- **不要开放3306端口到公网**（除非必要）
- **使用强密码**
- **只允许本地连接**（localhost）

### 3. SSH安全

```bash
# 修改SSH端口（可选）
nano /etc/ssh/sshd_config
# 修改 Port 22 为其他端口

# 禁用root登录（推荐）
# PermitRootLogin no

# 重启SSH服务
systemctl restart sshd
```

### 4. 定期备份

```bash
# 创建备份脚本
nano /root/backup.sh
```

```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
mysqldump -u flightuser -p你的密码 flight > /root/backup/flight_$DATE.sql
# 只保留最近7天的备份
find /root/backup -name "*.sql" -mtime +7 -delete
```

```bash
chmod +x /root/backup.sh

# 添加到定时任务（每天凌晨2点）
crontab -e
# 添加：0 2 * * * /root/backup.sh
```

---

## 📱 第五部分：客户端分发

### Windows客户端

1. **编译Release版本**
   - 在Qt Creator中选择Release配置
   - 编译生成exe文件

2. **打包依赖**
   - 使用windeployqt工具
   ```bash
   windeployqt.exe your_app.exe
   ```

3. **创建安装包**
   - 使用NSIS或Inno Setup
   - 或直接打包成zip

4. **分发方式**：
   - 官网下载
   - 应用商店
   - 网盘分享

### 配置服务器地址

**方法一：硬编码**（不推荐）
```cpp
QString serverIP = "你的服务器IP";
```

**方法二：配置文件**（推荐）
```cpp
// config.ini
[Server]
IP=你的服务器IP
Port=8888
```

**方法三：首次启动时输入**（用户体验好）
```cpp
// 第一次启动时弹出对话框让用户输入服务器地址
// 保存到配置文件或注册表
```

---

## 🎯 第六部分：监控和维护

### 1. 服务监控

**使用systemd查看服务状态**：
```bash
systemctl status flight-server
```

**查看日志**：
```bash
journalctl -u flight-server -n 100  # 最近100行
journalctl -u flight-server -f       # 实时查看
```

### 2. 性能监控

**查看服务器资源使用**：
```bash
# CPU和内存
top
# 或
htop

# 磁盘使用
df -h

# 网络连接
netstat -an | grep 8888
```

### 3. 日志管理

**服务端添加日志功能**：
```cpp
// 记录到文件
QFile logFile("server.log");
// 或使用Qt的日志系统
qInstallMessageHandler(myMessageHandler);
```

### 4. 自动重启

**使用systemd的Restart功能**（已在服务配置中设置）：
- 服务崩溃会自动重启
- 服务器重启后自动启动

---

## 💡 第七部分：优化建议

### 1. 性能优化

**数据库优化**：
- 添加索引
- 使用连接池
- 定期优化表

**服务端优化**：
- 使用多线程处理请求
- 实现连接池
- 添加缓存机制

### 2. 成本优化

**按需升级**：
- 先从小配置开始
- 根据实际使用情况升级
- 使用弹性伸缩（如果支持）

**使用CDN**（如果客户端需要下载资源）：
- 加速客户端下载
- 减轻服务器压力

### 3. 高可用性

**多服务器部署**：
- 主备服务器
- 负载均衡
- 数据库主从复制

---

## 📋 部署检查清单

### 服务器配置
- [ ] 云服务器已购买
- [ ] 安全组已配置（开放8888端口）
- [ ] SSH可以连接
- [ ] MySQL已安装并配置
- [ ] 数据库已导入
- [ ] 服务端程序已上传
- [ ] 服务端可以运行
- [ ] 服务端已设置为开机自启

### 客户端配置
- [ ] 客户端已修改服务器地址
- [ ] 客户端可以连接到服务器
- [ ] 所有功能测试通过

### 安全配置
- [ ] 防火墙已配置
- [ ] 数据库密码已修改
- [ ] SSH安全已配置
- [ ] 备份机制已设置

### 监控和维护
- [ ] 日志系统已配置
- [ ] 监控工具已设置
- [ ] 备份脚本已测试

---

## 🆘 常见问题

### Q1: 客户端连接不上服务器？
- 检查安全组是否开放8888端口
- 检查服务器防火墙
- 检查服务端是否在运行
- 使用telnet测试端口：`telnet 服务器IP 8888`

### Q2: 服务端启动失败？
- 检查数据库连接
- 检查端口是否被占用：`netstat -an | grep 8888`
- 查看错误日志

### Q3: 数据库连接失败？
- 检查MySQL服务是否运行：`systemctl status mysql`
- 检查用户名密码
- 检查数据库是否存在

### Q4: 如何查看服务端日志？
```bash
# 如果使用systemd
journalctl -u flight-server -f

# 如果使用nohup
tail -f /root/server.log
```

### Q5: 如何更新服务端？
```bash
# 停止服务
systemctl stop flight-server

# 上传新版本
scp new_FlightServer root@服务器IP:/root/

# 替换旧文件
mv /root/FlightServer /root/FlightServer.bak
mv /root/new_FlightServer /root/FlightServer
chmod +x /root/FlightServer

# 启动服务
systemctl start flight-server
```

---

## 🎓 总结

### 最小化部署方案（适合学习/测试）
- **服务器**：阿里云学生机（¥9.5/月）
- **配置**：1核2G，1M带宽
- **数据库**：服务器上自建MySQL
- **总成本**：约¥10/月

### 正式部署方案（适合小规模应用）
- **服务器**：阿里云ECS（1核2G，3M带宽）
- **配置**：按年付费
- **数据库**：服务器上自建MySQL
- **总成本**：约¥2000/年

### 生产环境方案（适合商业应用）
- **服务器**：2核4G或更高，5M带宽
- **数据库**：云数据库RDS（可选）
- **备份**：自动备份
- **监控**：云监控服务
- **总成本**：¥5000+/年

**建议**：先从最小化方案开始，根据实际需求逐步升级！

