# 利用现有网站服务器部署方案

## ✅ 完全可以！利用现有服务器的优势

如果你已经有一个可以运行的网站服务器，完全可以在这台服务器上部署你的Qt服务端程序，**不需要额外租用服务器**！

### 优势
- ✅ **节省成本**：不需要额外购买服务器
- ✅ **资源复用**：充分利用现有服务器资源
- ✅ **统一管理**：所有服务集中在一台服务器上
- ✅ **已有基础设施**：域名、SSL证书等可以复用

---

## 🏗️ 部署架构

### 方案一：同一服务器，不同端口（推荐）

```
┌─────────────────────────────────┐
│      你的网站服务器              │
│  ┌──────────┐   ┌──────────┐  │
│  │ Web服务  │   │ Qt服务端 │  │
│  │ (80/443) │   │ (8888)   │  │
│  └──────────┘   └──────────┘  │
│  ┌──────────┐                 │
│  │ MySQL    │                 │
│  │ 数据库   │                 │
│  └──────────┘                 │
└─────────────────────────────────┘
```

**特点**：
- Web服务运行在80/443端口（HTTP/HTTPS）
- Qt服务端运行在8888端口（TCP Socket）
- 两者互不干扰，可以同时运行

### 方案二：使用子域名

```
www.yourdomain.com     → Web网站（80/443端口）
api.yourdomain.com     → Qt服务端（8888端口）
```

**优点**：
- 更专业的架构
- 便于管理和扩展
- 可以使用不同的SSL证书

---

## 📋 部署步骤

### 步骤1：检查服务器环境

#### 1.1 确认服务器系统
```bash
# SSH连接到你的服务器
ssh user@your-server-ip

# 查看系统信息
uname -a
cat /etc/os-release
```

**常见系统**：
- **Linux**：Ubuntu、CentOS、Debian等（推荐）
- **Windows Server**：也可以，但需要配置

#### 1.2 检查现有服务
```bash
# 查看正在运行的端口
netstat -tulpn
# 或
ss -tulpn

# 查看80和443端口是否被占用（Web服务）
# 查看8888端口是否可用
```

#### 1.3 检查可用资源
```bash
# 查看CPU和内存
top
# 或
htop

# 查看磁盘空间
df -h

# 查看MySQL是否已安装
mysql --version
```

### 步骤2：安装必要软件

#### 2.1 如果服务器是Linux系统

**安装MySQL（如果还没有）**：
```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mysql-server -y

# CentOS/RHEL
sudo yum install mysql-server -y
# 或
sudo dnf install mysql-server -y

# 启动MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 设置MySQL root密码
sudo mysql_secure_installation
```

**创建数据库**：
```bash
mysql -u root -p

CREATE DATABASE flight CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'flightuser'@'localhost' IDENTIFIED BY '你的密码';
GRANT ALL PRIVILEGES ON flight.* TO 'flightuser'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

**导入数据库**：
```bash
# 上传你的 init_database.sql 到服务器
# 使用 scp 或 FTP 工具

# 导入
mysql -u flightuser -p flight < init_database.sql
```

#### 2.2 如果服务器是Windows Server

**安装MySQL**：
- 下载MySQL安装包：https://dev.mysql.com/downloads/mysql/
- 运行安装程序
- 配置root密码
- 使用MySQL Workbench或命令行创建数据库

**导入数据库**：
```cmd
mysql -u root -p flight < init_database.sql
```

### 步骤3：上传Qt服务端程序

#### 3.1 Linux服务器

**使用SCP上传**（在本地Windows命令行）：
```bash
scp FlightServer user@your-server-ip:/home/user/
```

**或使用FTP工具**：
- FileZilla（推荐）
- WinSCP
- 其他FTP客户端

**设置执行权限**：
```bash
ssh user@your-server-ip
chmod +x /home/user/FlightServer
```

#### 3.2 Windows服务器

**直接复制文件**：
- 使用远程桌面连接
- 或使用FTP工具上传
- 放到合适目录，如 `C:\FlightServer\`

### 步骤4：配置防火墙

#### 4.1 Linux防火墙（iptables/ufw）

**Ubuntu/Debian（使用ufw）**：
```bash
# 查看防火墙状态
sudo ufw status

# 开放8888端口
sudo ufw allow 8888/tcp

# 如果还没开放80和443（Web服务）
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 启用防火墙
sudo ufw enable
```

**CentOS/RHEL（使用firewalld）**：
```bash
# 开放8888端口
sudo firewall-cmd --permanent --add-port=8888/tcp
sudo firewall-cmd --reload

# 查看开放的端口
sudo firewall-cmd --list-ports
```

**如果使用iptables**：
```bash
sudo iptables -A INPUT -p tcp --dport 8888 -j ACCEPT
sudo iptables-save
```

#### 4.2 Windows防火墙

1. **打开"Windows Defender 防火墙"**
2. **高级设置 → 入站规则 → 新建规则**
3. **选择"端口" → TCP → 8888**
4. **允许连接**
5. **应用到所有配置文件**
6. **命名规则（如"Qt服务端端口"）**

### 步骤5：配置云服务商安全组（如果使用云服务器）

**阿里云/腾讯云/华为云等**：
1. 进入云服务器控制台
2. 找到你的服务器实例
3. **安全组 → 配置规则 → 添加规则**
4. **端口**：8888
5. **协议**：TCP
6. **授权对象**：0.0.0.0/0（或限制特定IP）
7. **描述**：Qt服务端端口

### 步骤6：修改服务端配置

#### 6.1 修改数据库连接

**编辑服务端代码或配置文件**：
```cpp
// server.cpp 中的 initDatabase()
QString connectionString = "DRIVER={MySQL ODBC 9.5 Unicode Driver};"
                           "SERVER=127.0.0.1;"  // 本地连接
                           "PORT=3306;"
                           "DATABASE=flight;"
                           "USER=flightuser;"
                           "PASSWORD=你的密码;"
                           "OPTION=3;";
```

**注意**：
- 如果MySQL在本地，使用 `127.0.0.1` 或 `localhost`
- 如果MySQL在其他服务器，使用MySQL服务器的IP

#### 6.2 确保监听所有网络接口

```cpp
// server.cpp
if (!server.listen(QHostAddress::Any, 8888)) {
    // QHostAddress::Any 表示监听所有网络接口
    // 这样外部才能连接
}
```

### 步骤7：运行服务端

#### 7.1 Linux系统

**方法一：直接运行（测试）**：
```bash
cd /home/user
./FlightServer
```

**方法二：后台运行（推荐）**：
```bash
# 使用 nohup
nohup ./FlightServer > server.log 2>&1 &

# 查看日志
tail -f server.log

# 查看进程
ps aux | grep FlightServer
```

**方法三：使用systemd服务（生产环境推荐）**：

创建服务文件：
```bash
sudo nano /etc/systemd/system/flight-server.service
```

内容：
```ini
[Unit]
Description=Flight Booking Server
After=network.target mysql.service

[Service]
Type=simple
User=你的用户名
WorkingDirectory=/home/user
ExecStart=/home/user/FlightServer
Restart=always
RestartSec=10
StandardOutput=append:/var/log/flight-server.log
StandardError=append:/var/log/flight-server-error.log

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable flight-server
sudo systemctl start flight-server

# 查看状态
sudo systemctl status flight-server

# 查看日志
sudo journalctl -u flight-server -f
```

#### 7.2 Windows系统

**方法一：直接运行**：
- 双击 `FlightServer.exe`
- 或在命令行运行

**方法二：作为Windows服务运行（推荐）**：

使用NSSM（Non-Sucking Service Manager）：
1. 下载NSSM：https://nssm.cc/download
2. 解压到 `C:\nssm\`
3. 以管理员身份运行命令提示符：
```cmd
cd C:\nssm\win64
nssm install FlightServer
```
4. 在弹出的GUI中配置：
   - **Path**: `C:\FlightServer\FlightServer.exe`
   - **Startup directory**: `C:\FlightServer\`
5. 启动服务：
```cmd
nssm start FlightServer
```

**或使用任务计划程序**：
1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：系统启动时
4. 操作：启动程序 `C:\FlightServer\FlightServer.exe`
5. 勾选"使用最高权限运行"

### 步骤8：测试连接

#### 8.1 在服务器上测试
```bash
# 检查端口是否监听
netstat -an | grep 8888
# 应该看到：0.0.0.0:8888 或 :::8888

# 使用telnet测试（如果安装了）
telnet localhost 8888
```

#### 8.2 从外部测试
```bash
# 在本地电脑测试
telnet 你的服务器IP 8888

# 或使用PowerShell
Test-NetConnection -ComputerName 你的服务器IP -Port 8888
```

#### 8.3 使用客户端测试
- 修改客户端代码中的服务器地址
- 运行客户端，尝试连接

### 步骤9：修改客户端连接地址

#### 9.1 硬编码方式
```cpp
// networkmanager.cpp
bool NetworkManager::connectToServer()
{
    // 改为你的服务器公网IP或域名
    return m_client->connectToServer("你的服务器IP", 8888);
    // 或使用域名
    // return m_client->connectToServer("api.yourdomain.com", 8888);
}
```

#### 9.2 配置文件方式（推荐）
```cpp
// 读取配置文件 config.ini
QSettings settings("config.ini", QSettings::IniFormat);
QString serverIP = settings.value("Server/IP", "127.0.0.1").toString();
int port = settings.value("Server/Port", 8888).toInt();
```

**config.ini 示例**：
```ini
[Server]
IP=你的服务器IP或域名
Port=8888
```

#### 9.3 首次启动输入（用户体验最好）
```cpp
// 第一次启动时，弹出对话框让用户输入服务器地址
// 保存到配置文件或注册表
QString serverIP = QInputDialog::getText(
    this, 
    "服务器设置", 
    "请输入服务器地址:", 
    QLineEdit::Normal, 
    "127.0.0.1"
);
```

---

## 🔧 常见配置场景

### 场景1：服务器已有Web服务（Apache/Nginx）

**不影响现有Web服务**：
- Web服务继续运行在80/443端口
- Qt服务端运行在8888端口
- 两者完全独立，互不干扰

**注意事项**：
- 确保8888端口没有被占用
- 防火墙开放8888端口
- 云服务商安全组开放8888端口

### 场景2：使用域名访问

**配置DNS解析**：
```
类型    主机记录    记录值          说明
A       api        你的服务器IP     Qt服务端子域名
```

**客户端连接**：
```cpp
// 使用域名连接
client->connectToServer("api.yourdomain.com", 8888);
```

**优点**：
- 如果服务器IP变更，只需修改DNS，不需要改客户端
- 更专业
- 可以使用SSL证书（如果服务端支持TLS）

### 场景3：服务器资源有限

**优化建议**：
- 监控CPU和内存使用
- 如果资源紧张，考虑：
  - 优化服务端代码（减少内存占用）
  - 限制并发连接数
  - 使用连接池
  - 考虑升级服务器配置

**查看资源使用**：
```bash
# 实时监控
top
htop

# 查看特定进程
ps aux | grep FlightServer
```

### 场景4：需要HTTPS/TLS加密

**如果服务端需要加密通信**：
1. 修改服务端使用 `QSslSocket` 代替 `QTcpSocket`
2. 配置SSL证书
3. 客户端也使用 `QSslSocket`

**但这会增加复杂度，对于内网或小规模应用，TCP Socket通常足够**

---

## ⚠️ 注意事项

### 1. 端口冲突
- **确保8888端口没有被占用**
- 如果被占用，可以改用其他端口（如8889、9999等）
- 修改服务端和客户端代码中的端口号

### 2. 防火墙配置
- **必须开放8888端口**，否则外部无法连接
- 同时检查云服务商的安全组设置

### 3. 数据库权限
- 确保数据库用户有足够权限
- 如果MySQL只允许本地连接，确保服务端在本地运行

### 4. 服务自启动
- **配置服务自启动**，避免服务器重启后服务端不运行
- Linux使用systemd
- Windows使用服务或任务计划程序

### 5. 日志管理
- 配置日志输出到文件
- 定期清理旧日志，避免占用磁盘空间

### 6. 资源监控
- 监控服务端的内存和CPU使用
- 如果占用过高，考虑优化或升级服务器

### 7. 备份
- 定期备份数据库
- 备份服务端程序
- 备份配置文件

---

## 🧪 测试清单

### 服务器端测试
- [ ] 服务端程序可以运行
- [ ] 端口8888正在监听
- [ ] 数据库连接正常
- [ ] 防火墙已开放8888端口
- [ ] 云服务商安全组已配置
- [ ] 服务可以自启动

### 客户端测试
- [ ] 可以连接到服务器
- [ ] 登录功能正常
- [ ] 查询功能正常
- [ ] 订单功能正常
- [ ] 所有功能测试通过

### 网络测试
- [ ] 从外部可以telnet到8888端口
- [ ] 客户端可以正常通信
- [ ] 数据传输正常

---

## 💡 优化建议

### 1. 使用反向代理（高级）

**如果使用Nginx**，可以配置反向代理：
```nginx
# /etc/nginx/sites-available/flight-api
server {
    listen 80;
    server_name api.yourdomain.com;
    
    location / {
        proxy_pass http://127.0.0.1:8888;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**但注意**：Qt服务端是TCP Socket，不是HTTP，所以Nginx的HTTP反向代理不适用。如果需要，可以考虑：
- 将服务端改为HTTP API
- 或使用TCP负载均衡器

### 2. 监控和告警

**设置监控**：
- 服务端进程监控
- 端口监听监控
- 数据库连接监控
- 资源使用监控

**告警机制**：
- 服务崩溃时发送邮件
- 资源使用过高时告警

### 3. 日志分析

**配置日志**：
- 记录所有请求
- 记录错误信息
- 定期分析日志，发现问题

---

## 🎯 总结

### 利用现有服务器的优势
✅ **零额外成本**：不需要租用新服务器  
✅ **资源复用**：充分利用现有资源  
✅ **统一管理**：集中管理所有服务  

### 关键步骤
1. ✅ 检查服务器环境和资源
2. ✅ 安装MySQL（如果没有）
3. ✅ 上传服务端程序
4. ✅ 配置防火墙和安全组
5. ✅ 运行服务端并设置自启动
6. ✅ 修改客户端连接地址
7. ✅ 测试所有功能

### 注意事项
⚠️ **端口冲突**：确保8888端口可用  
⚠️ **防火墙**：必须开放8888端口  
⚠️ **自启动**：配置服务自启动  
⚠️ **资源监控**：注意服务器资源使用  

**完全可以利用现有服务器！按照上述步骤操作即可。** 🚀


